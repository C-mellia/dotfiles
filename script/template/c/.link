#!/bin/bash

ld=gcc
ld_flag=(
    -L"$HOME"/.local/lib
)

function do_link() {
    declare LD TARGET INPUTS LD_FLAG
    declare -a CMD

    local INPUTS="$*"
    local CMD=(
    "${LD:?}" -o
    "${TARGET:?}"
    "$(for file in ${INPUTS:?}; do printf " %s " target/"$file".o; done)"
    "$LD_FLAG")

    echo "${CMD[@]}"; bash -c "${CMD[*]}" || {
        printf "Failed to link target \"%s\"\n" "${TARGET:?}" && exit 1
    }

    return 0
}

LD=$ld LD_FLAG="${ld_flag[*]}" TARGET=main do_link\
    "$(find target/ -type f\
    | /bin/grep -E '\.o$'\
    | while read -r file; do
    file=$(basename "$file" .o)
    printf " %s " "$file"
done)"

exit 0
