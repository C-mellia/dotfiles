#!/bin/bash

src_ext=c
cc=gcc
cc_flag=(
    -Wall -Wextra -Werror
    -std=gnu23
    -I./include
    -I"$HOME"/.local/include
)
srcs=$(
while read -r file; do
    basename "$file" ".${src_ext:?}" | /bin/grep -vE '^\.+'
done <<< "$(find src/ -type f | /bin/grep -E "\.${src_ext:?}\$")"
)

function do_compile() {
    declare CC CC_FLAG TARGET INPUT
    declare -a CMD

    local INPUT="${1?No input specified}"
    local CMD=("${CC:?}" -o "${TARGET:?}" -c "$INPUT" "$CC_FLAG")

    echo "${CMD[@]}"; bash -c "${CMD[*]}" || {
        echo "Failed to compile $INPUT" && exit 1
    }
}

for fname in $srcs; do
    CC=$cc CC_FLAG="${cc_flag[*]}" TARGET=./target/"$fname".o do_compile ./src/"$fname".${src_ext:?}
done

exit 0
